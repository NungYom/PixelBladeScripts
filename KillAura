-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- Parent for GUI
local guiParent = gethui and gethui() or game:FindFirstChild("CoreGui") or Players.LocalPlayer:WaitForChild("PlayerGui")

-- Main GUI Frame
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoFarmUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = guiParent

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 300, 0, 350)
MainFrame.Position = UDim2.new(0, 10, 0, 10)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- GUI Creation Helper
local function createButton(name, position)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 120, 0, 30)
    button.Position = position
    button.Text = name
    button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    button.TextColor3 = Color3.new(1, 1, 1)
    button.Parent = MainFrame
    return button
end

local function createInputSlider(name, position, default)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 200, 0, 50)
    frame.Position = position
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    frame.Parent = MainFrame

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0.4, 0)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = name .. ": " .. default
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Parent = frame

    local textbox = Instance.new("TextBox")
    textbox.Size = UDim2.new(1, 0, 0.6, 0)
    textbox.Position = UDim2.new(0, 0, 0.4, 0)
    textbox.Text = tostring(default)
    textbox.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    textbox.TextColor3 = Color3.new(1, 1, 1)
    textbox.ClearTextOnFocus = false
    textbox.Parent = frame

    local value = default
    textbox.FocusLost:Connect(function()
        local num = tonumber(textbox.Text)
        if num then
            value = num
            label.Text = name .. ": " .. tostring(value)
        else
            textbox.Text = tostring(value)
        end
    end)

    return function()
        return value
    end
end

-- GUI Controls
local digHereBtn = createButton("Dig Here", UDim2.new(0, 10, 0, 10))
local startBtn = createButton("Start", UDim2.new(0, 10, 0, 50))
local sellBtn = createButton("Sell", UDim2.new(0, 10, 0, 90))
local enchantBtn = createButton("Enchant", UDim2.new(0, 10, 0, 130))
local boostBtn = createButton("Boost OFF", UDim2.new(0, 10, 0, 170))
local autoSellBtn = createButton("Auto Sell OFF", UDim2.new(0, 10, 0, 210))

local getSand = createInputSlider("Sand", UDim2.new(0, 150, 0, 10), 7)
local getWater = createInputSlider("Water", UDim2.new(0, 150, 0, 70), 10)

-- Digging Position Storage
local savedPosition = nil
digHereBtn.MouseButton1Click:Connect(function()
    local character = Players.LocalPlayer.Character
    if character then
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if hrp then
            savedPosition = hrp.CFrame
        end
    end
end)

-- Flags
local boostEnabled = false
local autoSellEnabled = false

-- AutoFarm Logic
startBtn.MouseButton1Click:Connect(function()
    if not savedPosition then return end

    local character = Players.LocalPlayer.Character
    if not character then return end

    local scripts = character:WaitForChild("Worldshaker"):WaitForChild("Scripts")
    local digPoint = workspace:FindFirstChild("Dig Here")
    if not digPoint then return end

    local original = savedPosition
    local target = digPoint.Position + Vector3.new(0, 5, 0)

    task.spawn(function()
        while true do
            character = Players.LocalPlayer.Character
            if not character or not character:FindFirstChild("HumanoidRootPart") then break end
            if not workspace:FindFirstChild("Dig Here") then break end
            if character:FindFirstChildOfClass("Humanoid").Health <= 0 then break end

            character:PivotTo(CFrame.new(target))
            scripts.ToggleShovelActive:FireServer(true)

            local sandTime = getSand()
            local waterTime = getWater()
            local endSand = tick() + sandTime

            while tick() < endSand do task.wait() end

            scripts.ToggleShovelActive:FireServer(false)
            scripts.Collect:InvokeServer()
            scripts.Collect:InvokeServer(1)

            if autoSellEnabled then
                scripts.Sell:FireServer()
            end

            character:PivotTo(original)

            local endWater = tick() + waterTime
            while tick() < endWater do
                scripts.Shake:FireServer()
                task.wait()
            end
        end
    end)
end)

-- Sell Button
sellBtn.MouseButton1Click:Connect(function()
    local sell = Players.LocalPlayer.Character:FindFirstChild("Worldshaker"):FindFirstChild("Scripts"):FindFirstChild("Sell")
    if sell then sell:FireServer() end
end)

autoSellBtn.MouseButton1Click:Connect(function()
    autoSellEnabled = not autoSellEnabled
    autoSellBtn.Text = autoSellEnabled and "Auto Sell ON" or "Auto Sell OFF"
end)

-- Enchant Button
enchantBtn.MouseButton1Click:Connect(function()
    local args = { Instance.new("Tool", nil) }
    ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Crafting"):WaitForChild("Enchant"):InvokeServer(unpack(args))
end)

-- Boost Toggle
local function startBoost()
    boostEnabled = true
    task.spawn(function()
        while boostEnabled do
            pcall(function()
                local character = Players.LocalPlayer.Character
                local worldshaker = character and character:FindFirstChild("Worldshaker")
                if worldshaker then
                    local scripts = worldshaker:FindFirstChild("Scripts")
                    if scripts then
                        scripts:FindFirstChild("Collect"):InvokeServer()
                        scripts:FindFirstChild("Shake"):FireServer()
                        scripts:FindFirstChild("Pan"):InvokeServer()
                        scripts:FindFirstChild("Collect"):InvokeServer(1)
                    end
                end
            end)
            task.wait()
        end
    end)
end

local function stopBoost()
    boostEnabled = false
end

boostBtn.MouseButton1Click:Connect(function()
    if boostEnabled then
        stopBoost()
        boostBtn.Text = "Boost OFF"
    else
        startBoost()
        boostBtn.Text = "Boost ON"
    end
end)

-- GUI Toggle via Keybind
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.RightShift then
        MainFrame.Visible = not MainFrame.Visible
    end
end)
