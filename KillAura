-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")

-- State
local autoFarm4 = false
local farmDestination = nil
local collectDuration = 3 -- Sand slider (วินาที)
local shakeDuration = 20  -- Water slider (วินาที)

-- GUI Creation
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoFarmUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui
ScreenGui.IgnoreGuiInset = true
ScreenGui.DisplayOrder = 1000
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Utility Functions
local function createButton(name, pos, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 120, 0, 30)
    button.Position = pos
    button.BackgroundColor3 = Color3.fromRGB(51, 51, 51)
    button.BackgroundTransparency = 0.5
    button.TextColor3 = Color3.new(1,1,1)
    button.Text = name
    button.Font = Enum.Font.SourceSans
    button.TextSize = 18
    button.Parent = ScreenGui
    button.MouseButton1Click:Connect(callback)
    return button
end

local function createSlider(name, pos, defaultValue, callback)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 120, 0, 20)
    label.Position = pos
    label.BackgroundTransparency = 0.5
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Font = Enum.Font.SourceSans
    label.TextSize = 16
    label.Text = name .. ": " .. tostring(defaultValue)
    label.Parent = ScreenGui

    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(0, 120, 0, 10)
    sliderFrame.Position = pos + UDim2.new(0, 0, 0, 20)
    sliderFrame.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    sliderFrame.BackgroundTransparency = 0.5
    sliderFrame.BorderSizePixel = 0
    sliderFrame.Parent = ScreenGui

    local knob = Instance.new("Frame")
    knob.Size = UDim2.new(0, 15, 0, 15)
    knob.Position = UDim2.new((defaultValue - 1) / 49, 0, -0.25, 0)
    knob.BackgroundColor3 = Color3.new(1, 1, 1)
    knob.BackgroundTransparency = 0.5
    knob.BorderSizePixel = 0
    knob.Parent = sliderFrame

    local dragging = false

    knob.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
        end
    end)
    knob.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    sliderFrame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    RunService.RenderStepped:Connect(function()
        if dragging then
            local mouseX = UserInputService:GetMouseLocation().X
            local frameX = sliderFrame.AbsolutePosition.X
            local percent = math.clamp((mouseX - frameX) / sliderFrame.AbsoluteSize.X, 0, 1)
            local value = math.floor(percent * 49) + 1
            knob.Position = UDim2.new((value - 1) / 49, 0, -0.25, 0)
            label.Text = name .. ": " .. tostring(value)
            callback(value)
        end
    end)
end

-- Buttons

local startBtn = createButton("Start: OFF", UDim2.new(0, 10, 0, 10))
startBtn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)

local digHereBtn = createButton("Dig Here", UDim2.new(0, 10, 0, 50))

local sellBtn = createButton("Sell", UDim2.new(0, 10, 0, 90))

-- Sliders
local collectSliderPos = UDim2.new(0, 10, 0, 130)
local shakeSliderPos = UDim2.new(0, 10, 0, 170)

-- Variables to store original start position when pressing Start
local startPosition = nil

-- Helper Functions
local function getEquippedPanName()
    for _, tool in pairs(Character:GetChildren()) do
        if tool:IsA("Tool") and string.find(tool.Name, "Pan") then
            return tool.Name
        end
    end
    return nil
end

local function getEquippedPan()
    local panName = getEquippedPanName()
    if panName then
        return Character:FindFirstChild(panName)
    end
    return nil
end

-- Events

startBtn.MouseButton1Click:Connect(function()
    autoFarm4 = not autoFarm4
    startBtn.Text = "Start: " .. (autoFarm4 and "ON" or "OFF")
    startBtn.BackgroundColor3 = autoFarm4 and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)

    if autoFarm4 then
        startPosition = HRP.Position
    else
        startPosition = nil
    end
end)

digHereBtn.MouseButton1Click:Connect(function()
    farmDestination = HRP.Position
    Character:FindFirstChildOfClass("Humanoid"):ChangeState(Enum.HumanoidStateType.Jumping)
end)

sellBtn.MouseButton1Click:Connect(function()
    pcall(function()
        ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Shop"):WaitForChild("SellAll"):InvokeServer()
    end)
end)

createSlider("Sand", collectSliderPos, collectDuration, function(value)
    collectDuration = value
end)

createSlider("Water", shakeSliderPos, shakeDuration, function(value)
    shakeDuration = value
end)

-- Main AutoFarm Loop
spawn(function()
    while true do
        if autoFarm4 and farmDestination and startPosition and HRP and Character then
            pcall(function()
                -- วาร์ปไปจุด Dig Here
                HRP.CFrame = CFrame.new(farmDestination)
                wait(0.5)

                -- ช่วง Sand (collectDuration): รัว Collect สองฟังก์ชัน
                local startTime = tick()
                while tick() - startTime < collectDuration do
                    local pan = getEquippedPan()
                    if pan and pan.Scripts and pan.Scripts:FindFirstChild("Collect") then
                        pan.Scripts.Collect:InvokeServer()
                        pan.Scripts.Collect:InvokeServer(1)
                    end
                    wait(0.03)
                end

                -- วาร์ปกลับจุด Start
                HRP.CFrame = CFrame.new(startPosition)
                wait(0.2)

                -- ช่วง Water (shakeDuration): รัว Shake ฟังก์ชัน
                local shakeStart = tick()
                while tick() - shakeStart < shakeDuration do
                    local pan = getEquippedPan()
                    if pan and pan.Scripts and pan.Scripts:FindFirstChild("Shake") then
                        pan.Scripts.Shake:FireServer()
                    end
                    wait(0.03)
                end
            end)
        end
        wait(1)
    end
end)
