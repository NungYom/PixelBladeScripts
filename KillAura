--// Core Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

--// Player & Character
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

--// UI Container
local gui = Instance.new("ScreenGui")
gui.Name = "DeltaAutoFarmUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = gethui and gethui() or player:WaitForChild("PlayerGui")

--// Draggable Frame
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 260, 0, 320)
frame.Position = UDim2.new(0, 50, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

--// UI Template Function
local function createButton(name, order, callback)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, -20, 0, 30)
	btn.Position = UDim2.new(0, 10, 0, 10 + (order * 35))
	btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	btn.TextColor3 = Color3.new(1, 1, 1)
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 16
	btn.Text = name
	btn.Parent = frame
	btn.MouseButton1Click:Connect(callback)
	return btn
end

--// Saved Positions
local digPoint = nil
local returnPoint = nil
local isAutoRunning = false
local autoSell = false

--// Input Fields for Sand & Water
local sandBox = Instance.new("TextBox")
sandBox.Size = UDim2.new(1, -20, 0, 30)
sandBox.Position = UDim2.new(0, 10, 0, 200)
sandBox.Text = "7"
sandBox.TextColor3 = Color3.new(1,1,1)
sandBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
sandBox.Font = Enum.Font.SourceSansBold
sandBox.TextSize = 16
sandBox.Parent = frame

local waterBox = sandBox:Clone()
waterBox.Position = UDim2.new(0, 10, 0, 240)
waterBox.Text = "10"
waterBox.Parent = frame

--// Functions
local function teleportTo(cf)
	hrpsafe = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if hrpsafe then hrpsafe.CFrame = cf end
end

local function isPanFull()
	local pan = player.PlayerGui:FindFirstChild("MainUI") and player.PlayerGui.MainUI:FindFirstChild("Top")
	if pan then
		local fill = pan:FindFirstChild("Fill")
		return fill and tonumber(fill.Text:match("(%d+)%s*/%s*%d+")) == 150
	end
	return false
end

--// Buttons
createButton("Dig Here", 0, function()
	digPoint = hrp.CFrame
	character:FindFirstChildOfClass("Humanoid"):ChangeState(Enum.HumanoidStateType.Jumping)
end)

local startBtn = createButton("Start OFF", 1, function(btn)
	isAutoRunning = not isAutoRunning
	btn.Text = isAutoRunning and "Start ON" or "Start OFF"
	if isAutoRunning and digPoint then
		coroutine.wrap(function()
			returnPoint = hrp.CFrame
			while isAutoRunning and player.Character and player.Character:FindFirstChild("Humanoid") do
				teleportTo(digPoint)
				task.wait(tonumber(sandBox.Text) or 7)
				teleportTo(returnPoint)
				task.wait(tonumber(waterBox.Text) or 10)
			end
		end)()
	end
end)

createButton("Sell", 2, function()
	ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Shared"):WaitForChild("Sell"):FireServer()
end)

createButton("Enchant", 3, function()
	ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Shared"):WaitForChild("Enchant"):FireServer()
end)

local boostBtn = createButton("Boost ON", 4, function(btn)
	local boosting = true
	btn.Text = "Boost OFF"
	coroutine.wrap(function()
		while boosting do
			pcall(function()
				ReplicatedStorage.Modules.Shared.Shake:FireServer()
				ReplicatedStorage.Modules.Shared.Pan:InvokeServer()
				ReplicatedStorage.Modules.Shared.Collect:InvokeServer()
			end)
			RunService.Heartbeat:Wait()
		end
	end)()
	btn.MouseButton1Click:Connect(function()
		boosting = false
		btn.Text = "Boost ON"
	end)
end)

createButton("Auto Sell OFF", 5, function(btn)
	autoSell = not autoSell
	btn.Text = autoSell and "Auto Sell ON" or "Auto Sell OFF"
	if autoSell then
		coroutine.wrap(function()
			while autoSell do
				if isPanFull() then
					ReplicatedStorage.Modules.Shared.Sell:FireServer()
				end
				task.wait(1)
			end
		end)()
	end
end)

--// AFK/Death Detection
RunService.Heartbeat:Connect(function()
	if isAutoRunning and (not player.Character or not player.Character:FindFirstChild("Humanoid") or not digPoint) then
		isAutoRunning = false
		startBtn.Text = "Start OFF"
	end
end)

--// Resize Toggle
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0, 20, 0, 20)
toggleBtn.Position = UDim2.new(1, -25, 0, 5)
toggleBtn.Text = "⮝"
toggleBtn.Parent = frame

local minimized = false
toggleBtn.MouseButton1Click:Connect(function()
	minimized = not minimized
	for _, child in ipairs(frame:GetChildren()) do
		if child:IsA("TextButton") or child:IsA("TextBox") then
			child.Visible = not minimized
		end
	end
	toggleBtn.Text = minimized and "⮟" or "⮝"
end)

--// End
